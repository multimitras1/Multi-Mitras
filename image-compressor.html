<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Image Compressor ‚Äî KathaByte Tools</title>

  <!-- JSZip for batch download -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

  <style>
    :root{
      --bg1:#eaf6ff;
      --blue-deep:#0d47a1;
      --blue-mid:#0077d6;
      --accent:#00c3ff;
      --card-radius:14px;
      --text-dark:#042a4a;
      --glass: rgba(255,255,255,0.88);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      min-height:100vh;
      font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      background: radial-gradient(1200px 600px at 10% 10%, rgba(0,195,255,0.06), transparent),
                  linear-gradient(135deg,#e6f4ff 0%, #ffffff 60%);
      color:var(--text-dark);
      display:flex;
      align-items:start;
      justify-content:center;
      padding:20px;
    }

    .wrap{
      width:100%;
      max-width:1100px;
      display:grid;
      grid-template-columns: 1fr 320px;
      gap:18px;
      align-items:start;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,0.94), rgba(255,255,255,0.90));
      border-radius:var(--card-radius);
      padding:16px;
      box-shadow:0 10px 30px rgba(3,54,120,0.06);
      border:1px solid rgba(13,71,161,0.06);
    }

    header.card{
      grid-column:1/-1;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }

    h1{margin:0;font-size:18px;color:var(--blue-deep);display:flex;gap:10px;align-items:center}
    p.lead{margin:6px 0 0;color:#0b4b72;font-size:13px}

    /* Uploader */
    .uploader{
      border-radius:10px;
      padding:18px;
      background: linear-gradient(180deg, rgba(13,71,161,0.03), rgba(13,71,161,0.015));
      border:1px dashed rgba(13,71,161,0.06);
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items:center;
      justify-content:center;
      min-height:180px;
    }
    .drop{
      width:100%;
      padding:16px;
      border-radius:10px;
      text-align:center;
      cursor:pointer;
      background:linear-gradient(180deg, rgba(255,255,255,0.98), rgba(255,255,255,0.98));
      box-shadow: 0 6px 18px rgba(0,195,255,0.04);
      border:1px solid rgba(13,71,161,0.04);
    }
    .drop input{display:none}
    .small{font-size:13px;color:#0b4b72}

    /* Controls */
    .row{display:flex;gap:10px;flex-wrap:wrap}
    label{font-size:13px;color:#0b4b72;margin-bottom:6px;display:block}
    select,input[type="number"],input[type="range"],button{
      padding:10px;border-radius:10px;border:1px solid rgba(13,71,161,0.06);font-size:14px;background:#fff;color:var(--text-dark);
    }
    input[type="range"]{width:100%}
    .controls-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}

    button.primary{background:linear-gradient(90deg,var(--accent),var(--blue-mid));color:#fff;border:none;cursor:pointer;font-weight:700}
    button.ghost{background:transparent;border:1px dashed rgba(13,71,161,0.06);color:var(--blue-mid);cursor:pointer}

    /* Preview list */
    .preview-list{margin-top:12px;display:grid;gap:10px;max-height:520px;overflow:auto;padding-right:6px}
    .preview-item{display:flex;gap:12px;align-items:center;padding:10px;border-radius:10px;background:#fff;border:1px solid rgba(13,71,161,0.04)}
    .preview-item img{width:96px;height:64px;object-fit:cover;border-radius:8px}
    .meta{font-size:13px;color:#0b4b72}
    .meta b{color:var(--blue-deep)}

    .right-col{display:flex;flex-direction:column;gap:12px}
    .ad-slot{margin:12px 0;text-align:center}

    footer{grid-column:1/-1;margin-top:6px;font-size:12px;color:#0b4b72;text-align:center}

    @media(max-width:1000px){ .wrap{grid-template-columns:1fr} .right-col{order:-1} }
    @media(max-width:420px){ h1{font-size:16px} .preview-item img{width:72px;height:52px} }
  </style>
</head>
<body>
  <div class="wrap">

    <!-- Header + top banner ad -->
    <header class="card">
      <div>
        <h1>üñºÔ∏è Image Compressor</h1>
        <p class="lead">Compress images in-browser ‚Äî choose format, quality, resize and download. Batch support included.</p>
      </div>
      <div style="min-width:220px;text-align:right">
        <!-- Top Banner Ad (728x90) -->
        <div class="ad-slot" aria-hidden>
          <script type="text/javascript">
            atOptions = {
              'key' : 'a4236a38fef8b51c08a860f7e29b1a32',
              'format' : 'iframe',
              'height' : 90,
              'width' : 728,
              'params' : {}
            };
          </script>
          <script type="text/javascript" src="//lightingshovestature.com/a4236a38fef8b51c08a860f7e29b1a32/invoke.js"></script>
        </div>
      </div>
    </header>

    <!-- Main area -->
    <section class="card">
      <div class="uploader" id="uploader">
        <div class="drop" id="dropzone">
          <input type="file" id="fileInput" accept="image/*" multiple>
          <div style="font-weight:700;color:var(--blue-deep)">Click or Drop images here</div>
          <div class="small">Supported: JPEG, PNG, WebP ‚Äî Max browser limits apply</div>
        </div>

        <div class="controls-grid">
          <div>
            <label for="format">Output Format</label>
            <select id="format">
              <option value="image/jpeg">JPEG</option>
              <option value="image/png">PNG</option>
              <option value="image/webp" selected>WebP (best web)</option>
            </select>
          </div>

          <div>
            <label for="quality">Quality: <span id="qLabel">85%</span></label>
            <input id="quality" type="range" min="10" max="100" value="85">
          </div>

          <div>
            <label for="maxWidth">Max Width (px) ‚Äî 0 = keep</label>
            <input id="maxWidth" type="number" min="0" value="0" />
          </div>

          <div>
            <label for="maxHeight">Max Height (px) ‚Äî 0 = keep</label>
            <input id="maxHeight" type="number" min="0" value="0" />
          </div>
        </div>

        <div class="row" style="width:100%;margin-top:8px">
          <button class="primary" id="compressBtn">Compress Selected</button>
          <button class="ghost" id="clearBtn">Clear</button>
          <button class="ghost" id="downloadAllBtn">Download All (ZIP)</button>
        </div>

        <div style="width:100%;margin-top:8px">
          <div class="small">Tip: For web use WebP + quality 60‚Äì80. For photography use JPEG + 80‚Äì90.</div>
        </div>
      </div>

      <div class="preview-list" id="previewList">
        <!-- items will appear here -->
        <div class="small" style="opacity:.8">No images yet ‚Äî upload to start compressing.</div>
      </div>

      <!-- Middle Ad (300x250) -->
      <div class="ad-slot" aria-hidden style="margin-top:12px">
        <script type="text/javascript">
          atOptions = {
            'key' : '8a02d9520d2faa074d27d1b1582d7bf6',
            'format' : 'iframe',
            'height' : 250,
            'width' : 300,
            'params' : {}
          };
        </script>
        <script type="text/javascript" src="//lightingshovestature.com/8a02d9520d2faa074d27d1b1582d7bf6/invoke.js"></script>
      </div>
    </section>

    <!-- Right sidebar: options, results, ads -->
    <aside class="card right-col">
      <div>
        <label class="small">Selected files</label>
        <div id="summary" class="small">0 files ¬∑ Total original: 0 KB</div>
      </div>

      <div>
        <label class="small">Last operation</label>
        <div id="lastOp" class="small">‚Äî</div>
      </div>

      <!-- Side ad (160x300) -->
      <div class="ad-slot" aria-hidden>
        <script type="text/javascript">
          atOptions = {
            'key' : '962ff242b01ed125eb9b14423f7dbd3f',
            'format' : 'iframe',
            'height' : 300,
            'width' : 160,
            'params' : {}
          };
        </script>
        <script type="text/javascript" src="//lightingshovestature.com/962ff242b01ed125eb9b14423f7dbd3f/invoke.js"></script>
      </div>

      <!-- Bottom small banner (468x60) -->
      <div class="ad-slot" aria-hidden>
        <script type="text/javascript">
          atOptions = {
            'key' : '496188380e746eef901d9058c8f77c85',
            'format' : 'iframe',
            'height' : 60,
            'width' : 468,
            'params' : {}
          };
        </script>
        <script type="text/javascript" src="//lightingshovestature.com/496188380e746eef901d9058c8f77c85/invoke.js"></script>
      </div>
    </aside>

    <footer class="card">
      Image Compressor ‚Ä¢ Client-side compression ‚Äî no images uploaded to server unless you add server-side logic.
    </footer>
  </div>

<script>
  // Utilities & DOM
  const dropzone = document.getElementById('dropzone');
  const fileInput = document.getElementById('fileInput');
  const previewList = document.getElementById('previewList');
  const formatEl = document.getElementById('format');
  const qualityEl = document.getElementById('quality');
  const qLabel = document.getElementById('qLabel');
  const maxWidthEl = document.getElementById('maxWidth');
  const maxHeightEl = document.getElementById('maxHeight');
  const compressBtn = document.getElementById('compressBtn');
  const clearBtn = document.getElementById('clearBtn');
  const downloadAllBtn = document.getElementById('downloadAllBtn');
  const summary = document.getElementById('summary');
  const lastOp = document.getElementById('lastOp');

  let files = []; // {file, url, compressedBlob, compressedSize}

  // Update quality label
  qualityEl.addEventListener('input', () => qLabel.innerText = qualityEl.value + '%');

  // Drag & drop UI
  ['dragenter','dragover'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      dropzone.style.boxShadow = '0 8px 22px rgba(0,195,255,0.12)';
    });
  });
  ['dragleave','drop'].forEach(evt => {
    dropzone.addEventListener(evt, e => {
      e.preventDefault(); e.stopPropagation();
      dropzone.style.boxShadow = '';
    });
  });
  dropzone.addEventListener('drop', e => {
    const dt = e.dataTransfer;
    if (dt && dt.files) handleFiles(dt.files);
  });

  // Click to open file dialog
  dropzone.addEventListener('click', () => fileInput.click());
  fileInput.addEventListener('change', e => handleFiles(e.target.files));

  function handleFiles(fileList){
    const arr = Array.from(fileList).filter(f => f.type.startsWith('image/'));
    if (!arr.length) { alert('Please select image files.'); return; }
    arr.forEach(f => {
      const url = URL.createObjectURL(f);
      files.push({ file: f, url, compressedBlob: null, compressedSize: 0 });
    });
    renderPreviews();
  }

  function renderPreviews(){
    previewList.innerHTML = '';
    if (!files.length) {
      previewList.innerHTML = '<div class="small" style="opacity:.8">No images yet ‚Äî upload to start compressing.</div>';
      summary.innerText = '0 files ¬∑ Total original: 0 KB';
      return;
    }
    let totalOrig = 0;
    files.forEach((item, idx) => {
      totalOrig += item.file.size;
      const div = document.createElement('div');
      div.className = 'preview-item';
      div.innerHTML = `
        <img src="${item.url}" alt="${escapeHtml(item.file.name)}" />
        <div style="flex:1;text-align:left">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div style="font-weight:700">${escapeHtml(item.file.name)}</div>
            <div style="font-size:13px;color:#0b4b72">${(item.file.size/1024).toFixed(1)} KB</div>
          </div>
          <div class="meta" id="meta-${idx}">
            <div>Output: ${item.compressedBlob ? (item.compressedSize/1024).toFixed(1)+' KB' : 'Not compressed'}</div>
            <div style="margin-top:6px">
              <button class="ghost" data-idx="${idx}" data-action="compress">Compress</button>
              <button class="ghost" data-idx="${idx}" data-action="download" ${item.compressedBlob ? '' : 'disabled'}>Download</button>
              <button class="ghost" data-idx="${idx}" data-action="remove">Remove</button>
            </div>
          </div>
        </div>
      `;
      previewList.appendChild(div);
    });
    summary.innerText = `${files.length} files ¬∑ Total original: ${(totalOrig/1024).toFixed(1)} KB`;
    attachPreviewButtons();
  }

  function attachPreviewButtons(){
    previewList.querySelectorAll('button[data-action]').forEach(btn => {
      btn.addEventListener('click', async (e) => {
        const idx = +e.currentTarget.getAttribute('data-idx');
        const action = e.currentTarget.getAttribute('data-action');
        if (action === 'compress') {
          await compressSingle(idx);
        } else if (action === 'download') {
          downloadBlob(files[idx].compressedBlob, makeFilename(files[idx].file.name));
        } else if (action === 'remove') {
          URL.revokeObjectURL(files[idx].url);
          files.splice(idx,1);
          renderPreviews();
        }
      });
    });
  }

  // Compress all selected
  compressBtn.addEventListener('click', async () => {
    if (!files.length) { alert('No images selected.'); return; }
    lastOp.innerText = 'Compressing all...';
    for (let i=0;i<files.length;i++){
      await compressSingle(i);
    }
    lastOp.innerText = 'All images compressed ‚úÖ';
  });

  clearBtn.addEventListener('click', () => {
    files.forEach(f => URL.revokeObjectURL(f.url));
    files = [];
    renderPreviews();
    lastOp.innerText = 'Cleared';
  });

  // Download all as ZIP
  downloadAllBtn.addEventListener('click', async () => {
    if (!files.length) { alert('No files.'); return; }
    const zip = new JSZip();
    let any = false;
    for (let i=0;i<files.length;i++){
      const f = files[i];
      if (f.compressedBlob) {
        any = true;
        const arr = await f.compressedBlob.arrayBuffer();
        zip.file(makeFilename(f.file.name), arr);
      }
    }
    if (!any) { alert('No compressed files ‚Äî compress first.'); return; }
    lastOp.innerText = 'Creating ZIP...';
    const content = await zip.generateAsync({type:"blob"}, meta => {
      lastOp.innerText = `Zipping: ${Math.round(meta.percent)}%`;
    });
    downloadBlob(content, 'compressed-images.zip');
    lastOp.innerText = 'ZIP ready ‚úÖ';
  });

  // Compress single item (index)
  async function compressSingle(idx){
    const item = files[idx];
    lastOp.innerText = `Compressing ${item.file.name}...`;
    const format = formatEl.value;
    const quality = Math.max(0.01, Math.min(1, qualityEl.value/100));
    const maxW = parseInt(maxWidthEl.value) || 0;
    const maxH = parseInt(maxHeightEl.value) || 0;

    try {
      const img = await loadImage(item.url);
      // calculate resize
      let targetW = img.width, targetH = img.height;
      if (maxW > 0 && targetW > maxW) {
        const ratio = maxW / targetW;
        targetW = Math.round(targetW * ratio);
        targetH = Math.round(targetH * ratio);
      }
      if (maxH > 0 && targetH > maxH) {
        const ratio = maxH / targetH;
        targetW = Math.round(targetW * ratio);
        targetH = Math.round(targetH * ratio);
      }

      // create canvas & draw
      const canvas = document.createElement('canvas');
      canvas.width = targetW;
      canvas.height = targetH;
      const ctx = canvas.getContext('2d');

      // For PNG keep alpha, for JPEG force white background
      if (format === 'image/png' && imgHasAlpha(img)) {
        ctx.clearRect(0,0,canvas.width,canvas.height);
      } else {
        ctx.fillStyle = '#ffffff';
        ctx.fillRect(0,0,canvas.width,canvas.height);
      }

      ctx.drawImage(img, 0, 0, canvas.width, canvas.height);

      // toBlob conversion; for PNG quality is ignored in some browsers but we'll still pass param
      const blob = await new Promise(resolve => {
        // Take care: for large images this may take time
        canvas.toBlob(resolve, format, quality);
      });

      item.compressedBlob = blob;
      item.compressedSize = blob.size;
      // update UI
      renderPreviews();
      lastOp.innerText = `Compressed ${item.file.name} ‚Üí ${(blob.size/1024).toFixed(1)} KB`;
    } catch (err) {
      console.error(err);
      alert('Compression failed: ' + (err.message || err));
      lastOp.innerText = 'Error during compression';
    }
  }

  // Helpers
  function escapeHtml(s){ return String(s).replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

  function loadImage(url){
    return new Promise((res, rej) => {
      const img = new Image();
      img.onload = () => res(img);
      img.onerror = (e) => rej(new Error('Image load failed'));
      // avoid cross-origin tainting if local; use objectURL which is same-origin
      img.src = url;
    });
  }

  function imgHasAlpha(img){
    // quick heuristic: if PNG file name ends with .png assume alpha possible
    const name = (img.src || '').toLowerCase();
    return name.endsWith('.png') || name.includes('image/png');
  }

  function makeFilename(orig){
    const base = orig.replace(/\.[^/.]+$/, '');
    const ext = (formatEl.value === 'image/jpeg') ? 'jpg' : (formatEl.value === 'image/png' ? 'png' : 'webp');
    return `${base}-${qualityEl.value}q.${ext}`;
  }

  function downloadBlob(blob, filename){
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    setTimeout(()=> {
      URL.revokeObjectURL(a.href);
      a.remove();
    }, 5000);
  }

  // X buttons in preview are attached in renderPreviews
  // Also allow compress all by selecting multiple - already implemented

  // Simple persistence: remember last options
  window.addEventListener('beforeunload', () => {
    try {
      const opts = { format: formatEl.value, quality: qualityEl.value, maxW: maxWidthEl.value, maxH: maxHeightEl.value };
      localStorage.setItem('imgcomp_opts', JSON.stringify(opts));
    } catch(e){}
  });
  (function restoreOpts(){
    try {
      const raw = localStorage.getItem('imgcomp_opts');
      if (!raw) return;
      const o = JSON.parse(raw);
      if (o.format) formatEl.value = o.format;
      if (o.quality) { qualityEl.value = o.quality; qLabel.innerText = o.quality + '%'; }
      if (o.maxW) maxWidthEl.value = o.maxW;
      if (o.maxH) maxHeightEl.value = o.maxH;
    } catch(e){}
  })();

  // Clean up object URLs if page closed
  window.addEventListener('unload', () => {
    files.forEach(f => URL.revokeObjectURL(f.url));
  });

  // Accessibility: keyboard support for dropzone click
  dropzone.addEventListener('keydown', (e)=>{
    if (e.key === 'Enter' || e.key === ' ') fileInput.click();
  });

  // Done
</script>
</body>
</html>
